<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<title>Salesforce Custom Metadata Uploader</title>
		
		<script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
		<script src="js/jszip.js" type="text/javascript"></script>
		<script src="js/jsforce-core.min.js" type="text/javascript"></script>
		<script src="js/jsforce-api-metadata.min.js" type="text/javascript"></script>
		<script src="js/papaparse.js" type="text/javascript"></script>
		<script src="js/js.cookie.js" type="text/javascript"></script>
		<script src="js/mdTools.js" type="text/javascript"></script>
		
		<link rel="stylesheet" type="text/css" href="slds/assets/styles/salesforce-lightning-design-system.css" />
		
	</head>
	<body>
		
		<div id="loginAlert">
			
		</div>
		
		<div id="container" class="slds slds-hide">
			
			<div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_info" role="alert">
				<span class="slds-assistive-text">info</span>
				<span class="slds-icon_container slds-icon-utility-user slds-m-right_x-small" title="Description of icon when needed">
					<svg class="slds-icon slds-icon_x-small" aria-hidden="true">
						<use xlink:href="/assets/icons/utility-sprite/svg/symbols.svg#user"></use>
					</svg>
				</span>
				<h2>Logged in as <span id="userFullname"></span> <span id="userUsername"></span>.
					<a href="javascript:jsforce.browser.logout();">Log out</a>
				</h2>
			</div>
			
			<div role="status" id="spinner" class="slds-spinner slds-spinner_medium slds-spinner_brand">
				<span class="slds-assistive-text">Loading</span>
				<div class="slds-spinner__dot-a"></div>
				<div class="slds-spinner__dot-b"></div>
			</div>
			
			<div id="overlay" class="slds-backdrop slds-backdrop_open"></div>
			
			<div class="slds-page-header slds-m-bottom_medium slds-p-around_x-medium">
				<div class="slds-grid">
					<div class="slds-col slds-has-flexi-truncate">
						<div class="slds-media slds-no-space slds-grow">
							<div class="slds-media__figure">
								<span class="slds-icon_container slds-icon-standard-orders" title="Description of icon when needed">
									<svg class="slds-icon slds-icon_small" aria-hidden="true">
										<use xlink:href="slds/assets/icons/standard-sprite/svg/symbols.svg#orders"></use>
									</svg>
								</span>
							</div>
							<div class="slds-media__body">
								<h1 class="slds-page-header__title slds-truncate" title="Custom Metadata Uploader">Salesforce Custom Metadata Uploader</h1>
							</div>
						</div>
					</div>
					<div class="slds-col slds-no-flex slds-grid slds-align-top">
						<div class="slds-form-element">
							<div class="slds-form-element__icon slds-align-middle">
								<button class="slds-button slds-button_icon slds-button slds-button_icon slds-m-right_medium" aria-describedby="help" title="Help" onmouseover="showTooltip('help');" onmouseleave="hideTooltip('help');">
									<svg class="slds-button__icon" aria-hidden="true">
										<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="slds/assets/icons/utility-sprite/svg/symbols.svg#info" />
									</svg>
									<span class="slds-assistive-text">Help</span>
								</button>
							</div>
						</div>
						<div class="slds-popover slds-popover_tooltip slds-nubbin_top-right slds-rise-from-ground slds-hide" role="tooltip" id="help" style="position: absolute; top: 50px; right: 17px;">
							<div class="slds-popover__body">Sit nulla est ex deserunt exercitation anim occaecat. Nostrud ullamco deserunt aute id consequat veniam incididunt duis in sint irure nisi.</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="slds-grid slds-gutters slds-m-around_x-small">
				<div class="slds-col slds-size_1-of-3">
					
					<article class="slds-card">
						<div class="slds-card__header slds-grid">
							<header class="slds-media slds-media_center slds-has-flexi-truncate">
								<div class="slds-media__figure">
									<span class="slds-icon_container slds-icon-standard-entity" title="entity">
										<svg class="slds-icon slds-icon_small" aria-hidden="true">
											<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="slds/assets/icons/standard-sprite/svg/symbols.svg#entity"></use>
										</svg>
									</span>
								</div>
								<div class="slds-media__body">
									<h2 class="slds-card__header-title">
										<a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Accounts">
											<span class="slds-text-heading_small">Select Metadata Object</span>
										</a>
									</h2>
								</div>
							</header>
						</div>
						
						<div class="slds-card__body">
							<div class="slds-form-element slds-m-around_medium">
								<label class="slds-form-element__label" for="select-01">Custom Metadata Objects</label>
								<div class="slds-form-element__control">
									<div class="slds-select_container">
										<select class="slds-select" id="object-select">
											<option value="" disabled>Please select</option>
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>
					
				</article>
				
				<article class="slds-card">
					<div class="slds-card__header slds-grid">
						<header class="slds-media slds-media_center slds-has-flexi-truncate">
							<div class="slds-media__figure">
								<span class="slds-icon_container slds-icon-doctype-csv" title="csv">
									<svg class="slds-icon slds-icon_small" aria-hidden="true">
										<use xlink:href="slds/assets/icons/doctype-sprite/svg/symbols.svg#csv"></use>
									</svg>
								</span>
							</div>
							<div class="slds-media__body">
								<h2 class="slds-card__header-title">
									<a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Accounts">
										<span class="slds-text-heading_small">Select CSV File</span>
									</a>
								</h2>
							</div>
						</header>
					</div>
					<div class="slds-card__body">
						<div class="slds-form-element slds-m-around_medium">
							<div class="slds-form-element__control">
								<div class="slds-file-selector slds-file-selector_files">
									<div class="slds-file-selector__dropzone">
										<input type="file" class="slds-file-selector__input slds-assistive-text" accept=".csv" id="file-upload-input" aria-labelledby="file-selector-primary-label file-selector-secondary-label" />
										<label class="slds-file-selector__body" for="file-upload-input" id="file-selector-secondary-label">
											<span class="slds-file-selector__button slds-button slds-button_neutral">
												<svg class="slds-button__icon slds-button__icon_left" aria-hidden="true" >
													<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="slds/assets/icons/utility-sprite/svg/symbols.svg#upload" />
												</svg>Upload Files</span>
												<span class="slds-file-selector__text slds-medium-show">No File Selected</span>
										</label>
									</div>
								</div>
							</div>
						</div>
					</div>
				</article>
				
				<article class="slds-card slds-hide" id="file-info">
					<div class="slds-card__header slds-grid">
						<header class="slds-media slds-media_center slds-has-flexi-truncate">
							<div class="slds-media__figure">
								<span class="slds-icon_container slds-icon-standard-account" title="account">
									<svg class="slds-icon slds-icon_small" aria-hidden="true">
										<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="slds/assets/icons/standard-sprite/svg/symbols.svg#account"></use>
									</svg>
								</span>
							</div>
							<div class="slds-media__body">
								<h2 class="slds-card__header-title">
									<a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Accounts">
										<span class="slds-text-heading_small">File Information</span>
									</a>
								</h2>
							</div>
						</header>
					</div>
					<div class="slds-card__body slds-p-horizontal_medium">
						<dl class="slds-list_horizontal slds-wrap">
							<dt class="slds-item_label slds-text-color_weak slds-truncate" title="First Label">File Name:</dt>
							<dd class="slds-item_detail slds-truncate" title="File Name" id="file-name"></dd>
							<dt class="slds-item_label slds-text-color_weak slds-truncate" title="First Label">File Size:</dt>
							<dd class="slds-item_detail slds-truncate" title="File Name" id="file-size"></dd>
						</dl>
					</div>
				</article>
				
			</div>
			<div class="slds-col slds-size_2-of-3">
				<div id="results"></div>
			</div>
		</div>
		
	</div>
	
	<script>
	
		//init();
		
		var mdObjs = [];
		
		jsforce.browser.init({
			clientId: '3MVG9d8..z.hDcPI8U4xIar0rbAfGvpz7BlQxnsOysVaE4_ZcC9zCoNIbxYE.mMWcvnwcZJ.darnhxzlfTWtG',
			redirectUri: 'https://metadatatoolkit.herokuapp.com/authorize.htm',
			proxyUrl: 'https://node-salesforce-proxy.herokuapp.com/proxy/'
		});
		
		if(!jsforce.browser.isLoggedIn()){
			jsforce.browser.login();
		}
		
		jsforce.browser.on('connect', function(conn) {
			var userQuery = 'select Name, Username from User where Id = \'' + jsforce.browser.connection.userInfo.id + '\' limit 1';
			
			jsforce.browser.connection.query(userQuery, function(err, res){
				console.log(res);
				$('#userFullname').html(res.records[0].Name);
				$('#userUsername').html(' (' + res.records[0].Username + ')');
			});
			
			conn.describeGlobal(function(err, res) {
				if (err) { return console.error(err); }
				
				console.log('Num of SObjects : ' + res.sobjects.length);
				
				for(key in res.sobjects){
					if(res.sobjects[key].name.includes('__mdt')){
						mdObjs.push(res.sobjects[key]);
						
						$('#object-select').append($("<option></option>")
						.attr("value", res.sobjects[key].name)
						.text(res.sobjects[key].label));
					}
				}
				
				console.log(mdObjs);
				
				$('#overlay').removeClass('slds-backdrop_open');
				$('#spinner').addClass('slds-hide');
				$('#loginAlert').addClass('slds-hide');
				$('#container').removeClass('slds-hide');
				
			});
		});
		
		$('#file-upload-input').change(function(){
			$('#file-info').removeClass('slds-hide');
			var file = $(this)[0].files[0];
			console.log(file);
			
			console.log('File Size Data:');
			console.log(file.size + ' bytes');
			console.log(file.size / 1024 + ' kb');
			console.log(((file.size / 1024) / 1024) + ' Mb');
			
			$('#input-file-name').html(file.name);
			$('#file-name').html(file.name);
			$('#file-size').html((file.size / 1024).toFixed(1) + ' KB');
			
			var reader = new FileReader();
			reader.onload = function(){
				var dataURL = reader.result;
				var output = document.getElementById('output');
				output.src = dataURL;
			};
			reader.readAsDataURL(input.files[0]);
			
		});
	</script>
	
</body>

<html>			