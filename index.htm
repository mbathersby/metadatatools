<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="x-ua-compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		
		<title>Salesforce Custom Metadata Uploader</title>
		
		<script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
		<script src="js/moment.js" type="text/javascript"></script>
		<script src="js/jszip.js" type="text/javascript"></script>
		<script src="js/jsforce-core.min.js" type="text/javascript"></script>
		<script src="js/jsforce-api-metadata.min.js" type="text/javascript"></script>
		<script src="js/papaparse.js" type="text/javascript"></script>
		<script src="js/js.cookie.js" type="text/javascript"></script>
		<script src="js/mdTools.js" type="text/javascript"></script>
		
		<link rel="stylesheet" type="text/css" href="slds/assets/styles/salesforce-lightning-design-system.css" />
		
	</head>
	<body>
	
		<div role="status" id="spinner" class="slds-spinner slds-spinner_medium slds-spinner_brand slds-hide">
			<span class="slds-assistive-text">Loading</span>
			<div class="slds-spinner__dot-a"></div>
			<div class="slds-spinner__dot-b"></div>
		</div>
		
		<div id="overlay" class="slds-backdrop slds-backdrop_open"></div>
		
		<div id="noLoginContainer" class="slds slds-hide">
			<section role="alertdialog" tabindex="-1" aria-labelledby="prompt-heading-id" aria-describedby="prompt-message-wrapper" class="slds-modal slds-fade-in-open slds-modal_prompt" aria-modal="true">
				<div class="slds-modal__container">
					<header class="slds-modal__header slds-theme_info slds-theme_alert-texture">
						<button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close">
							<svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
								<use xlink:href="slds/assets/icons/utility-sprite/svg/symbols.svg#close" />
							</svg>
							<span class="slds-assistive-text">Close</span>
						</button>
						<h2 class="slds-text-heading_medium" id="prompt-heading-id">Authentication Required</h2>
					</header>
					<div class="slds-modal__content slds-p-around_medium slds-text-align_center" id="prompt-message-wrapper">
						<p>You must be loged in to a Salesforce Instance to use this toolkit</p>
					</div>
					<footer class="slds-modal__footer slds-theme_default">
						<button class="slds-button slds-button_neutral" onclick="login('login');">Production Login</button>
						<button class="slds-button slds-button_neutral" onclick="login('test');">Sandbox Login</button>
					</footer>
				</div>
			</section>
		</div>
		
		<div id="container" class="slds slds-hide">
			
			<div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_info" role="alert">
				<span class="slds-assistive-text">info</span>
				<span class="slds-icon_container slds-icon-utility-user slds-m-right_x-small" title="Description of icon when needed">
					<svg class="slds-icon slds-icon_x-small" aria-hidden="true">
						<use xlink:href="slds/assets/icons/utility-sprite/svg/symbols.svg#user"></use>
					</svg>
				</span>
				<h2>Logged in as <span id="userFullname"></span> <span id="userUsername"></span>.
					<a onclick="logout();">Log out</a>
				</h2>
			</div>

			
			<div class="slds-page-header slds-m-bottom_medium slds-p-around_x-medium">
				<div class="slds-grid">
					<div class="slds-col slds-has-flexi-truncate">
						<div class="slds-media slds-no-space slds-grow">
							<div class="slds-media__figure">
								<span class="slds-icon_container slds-icon-standard-orders" title="Description of icon when needed">
									<svg class="slds-icon slds-icon_small" aria-hidden="true">
										<use xlink:href="slds/assets/icons/standard-sprite/svg/symbols.svg#orders"></use>
									</svg>
								</span>
							</div>
							<div class="slds-media__body">
								<h1 class="slds-page-header__title slds-truncate" title="Custom Metadata Uploader">Salesforce Custom Metadata Uploader</h1>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="slds-grid slds-gutters slds-m-around_x-small">
				<div class="slds-col slds-size_1-of-3">
					
					<article class="slds-card">
						<div class="slds-card__header slds-grid">
							<header class="slds-media slds-media_center slds-has-flexi-truncate">
								<div class="slds-media__figure">
									<span class="slds-icon_container slds-icon-standard-entity" title="entity">
										<svg class="slds-icon slds-icon_small" aria-hidden="true">
											<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="slds/assets/icons/standard-sprite/svg/symbols.svg#entity"></use>
										</svg>
									</span>
								</div>
								<div class="slds-media__body">
									<h2 class="slds-card__header-title">
										<a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Accounts">
											<span class="slds-text-heading_small">Select Metadata Object</span>
										</a>
									</h2>
								</div>
							</header>
						</div>
						
						<div class="slds-card__body">
							<div class="slds-form-element slds-m-around_medium">
								<label class="slds-form-element__label" for="select-01">Custom Metadata Objects</label>
								<div class="slds-form-element__control">
									<div class="slds-select_container">
										<select class="slds-select" id="object-select">
											<option value="" disabled selected>Please select</option>
										</select>
									</div>
								</div>
							</div>
						</div>
						
					</article>
					
					<article class="slds-card">
						<div class="slds-card__header slds-grid">
							<header class="slds-media slds-media_center slds-has-flexi-truncate">
								<div class="slds-media__figure">
									<span class="slds-icon_container slds-icon-doctype-csv" title="csv">
										<svg class="slds-icon slds-icon_small" aria-hidden="true">
											<use xlink:href="slds/assets/icons/doctype-sprite/svg/symbols.svg#csv"></use>
										</svg>
									</span>
								</div>
								<div class="slds-media__body">
									<h2 class="slds-card__header-title">
										<a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Accounts">
											<span class="slds-text-heading_small">Select CSV File</span>
										</a>
									</h2>
								</div>
							</header>
						</div>
						<div class="slds-card__body">
							<div class="slds-form-element slds-m-around_medium">
								<div class="slds-form-element__control">
									<div class="slds-file-selector slds-file-selector_files">
										<div class="slds-file-selector__dropzone">
											<input type="file" class="slds-file-selector__input slds-assistive-text" accept=".csv" id="file-upload-input" aria-labelledby="file-selector-primary-label file-selector-secondary-label" />
											<label class="slds-file-selector__body" for="file-upload-input" id="file-selector-secondary-label">
												<span class="slds-file-selector__button slds-button slds-button_neutral">
													<svg class="slds-button__icon slds-button__icon_left" aria-hidden="true" >
														<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="slds/assets/icons/utility-sprite/svg/symbols.svg#upload" />
													</svg>Upload Files</span>
													<span name="fileName" class="slds-file-selector__text slds-medium-show">No File Selected</span>
											</label>
										</div>
									</div>
								</div>
							</div>
						</div>
					</article>
					
					<article class="slds-card slds-hide" id="file-info">
						<div class="slds-card__header slds-grid">
							<header class="slds-media slds-media_center slds-has-flexi-truncate">
								<div class="slds-media__figure">
									<span class="slds-icon_container slds-icon-standard-account" title="account">
										<svg class="slds-icon slds-icon_small" aria-hidden="true">
											<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="slds/assets/icons/standard-sprite/svg/symbols.svg#account"></use>
										</svg>
									</span>
								</div>
								<div class="slds-media__body">
									<h2 class="slds-card__header-title">
										<a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Accounts">
											<span class="slds-text-heading_small">File Information</span>
										</a>
									</h2>
								</div>
							</header>
						</div>
						<div class="slds-card__body slds-p-horizontal_medium">
							<dl class="slds-list_horizontal slds-wrap">
								<dt class="slds-item_label slds-text-color_weak slds-truncate" title="First Label">File Name:</dt>
								<dd class="slds-item_detail slds-truncate" title="File Name" name="fileName"></dd>
								<dt class="slds-item_label slds-text-color_weak slds-truncate" title="First Label">File Size:</dt>
								<dd class="slds-item_detail slds-truncate" title="File Name" id="file-size"></dd>
								<dt class="slds-item_label slds-text-color_weak slds-truncate" title="First Label">Last Modified:</dt>
								<dd class="slds-item_detail slds-truncate" title="File Name" id="last-modified"></dd>
								<dt class="slds-item_label slds-text-color_weak slds-truncate" title="First Label">Total Rows:</dt>
								<dd class="slds-item_detail slds-truncate" title="File Name" id="rowCount"></dd>
							</dl>
						</div>
					</article>
					
				</div>
				<div class="slds-col slds-size_2-of-3">

						<article class="slds-card" id="mappingTable">
							<div class="slds-card__header slds-grid">
								<header class="slds-media slds-media_center slds-has-flexi-truncate">
									<div class="slds-media__body">
										<h2 class="slds-card__header-title">
											<a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Accounts">
												<span class="slds-text-heading_small">Map CSV Columns</span>
											</a>
										</h2>
									</div>
								</header>
							</div>
							<div class="slds-card__body slds-p-horizontal_medium">
								
								<table class="slds-table slds-table_bordered slds-table_cell-buffer slds-table_col-bordered">
									<thead>
										<tr class="slds-text-title_caps">
											<th scope="col slds-size_1-of-2">
												<div class="slds-truncate" title="Column Name">Column Name</div>
											</th>
											<th scope="col slds-size_1-of-2">
												<div class="slds-truncate" title="Map To">Map To</div>
											</th>
										</tr>
									</thead>
									<tbody id="mappingTableBody">
										
										
										
									</tbody>
								</table>
								
							</div>
						</article>

				</div>
			</div>
			
		</div>
		
		<script>
		
			$(document).ready(this, init());

			var mdObjs = [];
			var csvFile;
			var selectedObj;

			if(!jsforce.browser.isLoggedIn()){
				$('#noLoginContainer').removeClass('slds-hide');
			} 
				
				
				
			jsforce.browser.on('connect', function(conn) {
			
				$('#overlay').addClass('slds-backdrop_open');
				$('#spinner').removeClass('slds-hide');
				
				console.log('Connecting to ' + conn.instanceUrl);
				$('#noLoginContainer').addClass('slds-hide');
				var userQuery = 'select Name, Username from User where Id = \'' + conn.userInfo.id + '\' limit 1';
				
				conn.query(userQuery, function(err, res){
					$('#userFullname').html(res.records[0].Name);
					$('#userUsername').html(' (' + res.records[0].Username + ')');
				}).then(function(res){
					conn.describeGlobal(function(err, res) {
						if (err) { return console.error(err); }
						
						for(key in res.sobjects){
							if(res.sobjects[key].name.includes('__mdt')){
								mdObjs.push(res.sobjects[key]);
								
								$('#object-select').append($("<option></option>")
								.attr("value", res.sobjects[key].name)
								.text(res.sobjects[key].label + ' (' + res.sobjects[key].name + ')')
								);
							}
						}
					});
				}).then(function(){
					$('#overlay').removeClass('slds-backdrop_open');
					$('#spinner').addClass('slds-hide');
					$('#container').removeClass('slds-hide');
				});
			});
			
			function logout(){
				jsforce.browser.logout();
				window.location.reload();
			}
			
			$('#file-upload-input').change(function(){
				$('#file-info').removeClass('slds-hide');
				var file = $(this)[0].files[0];
				
				$("[name='fileName']").html(file.name);
				$('#file-size').html((file.size / 1024).toFixed(1) + ' KB');
				
				$('#last-modified').html(moment(file.lastModified).format('lll'));
				
				var reader = new FileReader();
				
				reader.onload = function(){
					csvFile = Papa.parse(reader.result, {header:true});
					console.log('CSV File Data');
					console.log(csvFile);
					$("#rowCount").html(csvFile.data.length);
				};
				
				reader.readAsText(file);
				
			});
			
			$('#object-select').change(function(){
				//selectedObj = $('#object-select').val();
				//console.log('Selected Object: ', selectedObj);
				
				var conn = jsforce.browser.connection;
				
				conn.sobject($(this).val())describe(function(err, res) {
					selectedObj = res;
					console.log('Selected Object: ', selectedObj);
				});
				
			});
		</script>
		
	</body>
	
<html>			